<!-- è¼‰å…¥ OpenCC æœ€æ–°å®Œæ•´ç‰ˆ -->
<script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>

<style>
  #cc-toggle-container {
    position: fixed !important;
    top: 70% !important;
    right: 50px !important;
    transform: translateY(-50%) !important;
    z-index: 2147483647 !important;
    display: block !important;
    visibility: visible !important;
    transition: right 0.3s ease !important;
    width: 40px !important;
    height: 10px !important;
  }
  
  #cc-toggle {
    background: rgba(0, 0, 0, 0.65) !important;
    color: rgba(255, 255, 255, 0.9) !important;
    border: none !important;
    border-radius: 20px 0 0 20px !important;
    padding: 8px 30px!important;
    font-size: 17px !important;
    cursor: pointer !important;
    width: 100% !important;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2) !important;
    text-align: center !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    transform: translateX(calc(100% - 40px)) !important;
    transition: transform 0.3s ease, background 0.2s ease !important;
  }
  
  #cc-toggle:hover {
    transform: translateX(0) !important;
    background: rgba(0, 0, 0, 0.8) !important;
  }
</style>

<script>
(function () {
  let isSimplified = false;
  let toCN, toTW;
  let lastPath = location.pathname;
  
  // åˆ›å»ºå¹¶æ˜¾ç¤ºæŒ‰é’®çš„å‡½æ•°
  function createAndShowButton() {
    console.log('å°è¯•åˆ›å»ºç¹ç®€è½¬æ¢æŒ‰é’®');
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å®¹å™¨å’ŒæŒ‰é’®
    if (document.getElementById('cc-toggle-container')) {
      console.log('æŒ‰é’®å·²å­˜åœ¨ï¼Œç¡®ä¿å…¶å¯è§');
      ensureButtonVisible();
      return;
    }
    
    // åˆ›å»ºå®¹å™¨
    let container = document.createElement('div');
    container.id = 'cc-toggle-container';
    
    // åˆ›å»ºæŒ‰é’®
    let btn = document.createElement('button');
    btn.id = 'cc-toggle';
    btn.textContent = isSimplified ? 'ç¹é«”/ç®€ä½“' : 'ç®€ä½“/ç¹é«”';
    
    // æ·»åŠ åˆ°DOM
    container.appendChild(btn);
    document.body.appendChild(container);
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
    btn.onclick = async () => {
      console.log('æŒ‰é’®è¢«ç‚¹å‡»');
      isSimplified = !isSimplified;
      localStorage.setItem('langPref', isSimplified ? 'cn' : 'tw');
      await convertPage(isSimplified);
      btn.textContent = isSimplified ? 'ç¹é«”/ç®€ä½“' : 'ç®€ä½“/ç¹é«”';
    };
    
    console.log('æŒ‰é’®åˆ›å»ºå®Œæˆ');
    ensureButtonVisible();
  }
  
  // ç¡®ä¿æŒ‰é’®å¯è§
  function ensureButtonVisible() {
    let container = document.getElementById('cc-toggle-container');
    let btn = document.getElementById('cc-toggle');
    if (!container || !btn) return;
    
    // å¼ºåˆ¶è®¾ç½®æ˜¾ç¤ºå±æ€§
    container.style.display = 'block';
    container.style.visibility = 'visible';
    container.style.zIndex = '2147483647';
    
    btn.style.display = 'flex';
    btn.style.visibility = 'visible';
    console.log('å·²åº”ç”¨å¼ºåˆ¶æ˜¾ç¤ºæ ·å¼');
  }

  async function initOpenCC() {
    toCN = await OpenCC.Converter({ from: 'twp', to: 'cn' });
    toTW = await OpenCC.Converter({ from: 'cn', to: 'twp' });
    console.log('OpenCC åˆå§‹åŒ–å®Œæˆ');
  }

  async function convertPage(toSimplified = true) {
    const main = document.querySelector('main') || document.body;
    const walker = document.createTreeWalker(main, NodeFilter.SHOW_TEXT, null, false);
    while (walker.nextNode()) {
      const node = walker.currentNode;
      const text = node.nodeValue;
      if (!text.trim()) continue;
      try {
        node.nodeValue = toSimplified ? await toCN(text) : await toTW(text);
      } catch (e) {
        console.warn('è½‰æ›éŒ¯èª¤ï¼š', e);
      }
    }
  }

  async function applyLanguageFromPref() {
    const pref = localStorage.getItem('langPref') || 'tw';
    isSimplified = (pref === 'cn');
    if (isSimplified) {
      await convertPage(true);
    }
    createAndShowButton();
  }

  function monitorSPAChange() {
    setInterval(async () => {
      const currentPath = location.pathname;
      if (currentPath !== lastPath) {
        lastPath = currentPath;
        console.log('ğŸ“¦ åµæ¸¬åˆ°é é¢åˆ‡æ›ï¼Œè‡ªå‹•å¥—ç”¨èªè¨€èˆ‡æŒ‰éˆ•');
        setTimeout(() => applyLanguageFromPref(), 800);
      }
    }, 1000);
  }

  async function initialize() {
    console.log('å¼€å§‹åˆå§‹åŒ–ç¹ç®€è½¬æ¢åŠŸèƒ½');
    try {
      await initOpenCC();
      await applyLanguageFromPref();
      monitorSPAChange();
    } catch (e) {
      console.error('åˆå§‹åŒ–å‡ºé”™:', e);
    }
  }

  // å°è¯•å¤šç§æ–¹å¼ç¡®ä¿ä»£ç æ‰§è¡Œ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initialize);
  } else {
    initialize();
  }
  
  // é¢å¤–å®‰å…¨æªæ–½ï¼Œç¡®ä¿æŒ‰é’®æœ€ç»ˆä¼šæ˜¾ç¤º
  setTimeout(createAndShowButton, 1000);
  setTimeout(createAndShowButton, 2000);
})();
</script>